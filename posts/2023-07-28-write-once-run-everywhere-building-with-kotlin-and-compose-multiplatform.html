<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>
    (function(){
      var k='portfolio-theme';
      var stored=localStorage.getItem(k);
      var dark=stored==='dark'||(stored!=='light'&&window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches);
      document.documentElement.setAttribute('data-theme',dark?'dark':'light');
      document.documentElement.style.backgroundColor=dark?'#141218':'#fef7ff';
    })();
  </script>
  <title>Write Once, Run Everywhere: Kotlin and Compose Multiplatform | Vladislav Kochetov</title>
  <meta name="description" content="Build a simple app with Kotlin Multiplatform, Compose Multiplatform, Coroutines, Serialization, and Ktor — Android and iOS from one codebase.">
  <link rel="canonical" href="https://vladleesi.dev/posts/2023-07-28-write-once-run-everywhere-building-with-kotlin-and-compose-multiplatform.html">
  <meta property="og:title" content="Write Once, Run Everywhere: Kotlin and Compose Multiplatform | Vladislav Kochetov">
  <meta property="og:description" content="A simple app with Kotlin multiplatform, Compose multiplatform, Coroutines, Serialization, and Ktor — Android and iOS.">
  <meta property="og:url" content="https://vladleesi.dev/posts/2023-07-28-write-once-run-everywhere-building-with-kotlin-and-compose-multiplatform.html">
  <meta property="og:type" content="article">
  <meta property="og:locale" content="en_US">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Kotlin and Compose Multiplatform | Vladislav Kochetov">
  <meta name="twitter:description" content="Kotlin Multiplatform, Compose Multiplatform — Android and iOS from one codebase.">
  <link rel="apple-touch-icon" sizes="180x180" href="../assets/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../assets/favicon-16x16.png">
  <link rel="shortcut icon" href="../assets/favicon.ico">
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"></noscript>
  <link rel="stylesheet" href="../assets/css/styles.css">
  <link rel="stylesheet" href="../assets/css/article.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <meta name="referrer" content="strict-origin-when-cross-origin">
</head>
<body class="article-page" data-post-id="post2">
  <div id="reading-progress" class="reading-progress" aria-hidden="true"></div>
  <div id="site-header"></div>
  <main>
    <article class="article-container">
      <a href="/" class="article-back">Back to home</a>
      <header class="article-title-wrap">
        <h1 class="article-title">Write Once, Run Everywhere: Building with Kotlin and Compose Multiplatform</h1>
        <p class="article-meta"><time datetime="2023-07-28">Jul 28, 2023</time></p>
      </header>
      <div class="article-body">
        <p class="reveal-item">Welcome to the world of Kotlin multiplatform app development! In this article, we'll explore a simple example of an app built entirely with Kotlin. We'll leverage the power of Kotlin multiplatform, Compose multiplatform, Kotlin Coroutines, Kotlin Serialization, and Ktor to create an app that runs smoothly on both Android and iOS platforms.</p>
        <p class="reveal-item">The focus here is on creating a multiplatform app that uses shared network logic and user interface only just on Kotlin.</p>
        <p class="reveal-item">We require macOS, <a href="https://developer.android.com/studio" target="_blank" rel="noopener noreferrer">Android Studio</a>, <a href="https://plugins.jetbrains.com/plugin/14936-kotlin-multiplatform-mobile" target="_blank" rel="noopener noreferrer">Kotlin Multiplatform plugin</a>, <a href="https://developer.apple.com/xcode/" target="_blank" rel="noopener noreferrer">Xcode</a>, and a dash of enthusiasm!</p>
        <blockquote class="reveal-item">
          <p><strong>Disclaimer:</strong> I aim to focus solely on essential aspects. For the complete code, please refer to the following GitHub repository: <a href="https://github.com/vladleesi/factastic" target="_blank" rel="noopener noreferrer">https://github.com/vladleesi/factastic</a>.</p>
        </blockquote>
        <p class="reveal-item">So, let's get started!</p>
        <p class="reveal-item">To begin, let's create a multiplatform project in Android Studio by selecting "New Project" and then choosing the "Kotlin Multiplatform App" template.</p>
        <figure class="reveal-item">
          <img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wnn34qwg4p77gjuy6gam.png" alt="Creation of new multiplatform project" loading="lazy">
        </figure>
        <p class="reveal-item">After creating the multiplatform project in Android Studio, the next step is to add all the necessary dependencies and plugins.</p>
        <div class="code-block-wrap reveal-item">
          <button type="button" class="code-copy" aria-label="Copy code">Copy</button>
          <pre><code class="language-kotlin">// gradle.properties
org.jetbrains.compose.experimental.uikit.enabled = true
kotlin.native.cacheKind = none

// build.gradle.kts (app)
plugins {
    kotlin("multiplatform").apply(false)
    id("com.android.application").apply(false)
    id("com.android.library").apply(false)
    id("org.jetbrains.compose").apply(false)
    kotlin("plugin.serialization").apply(false)
}


// settings.gradle.kts
plugins {
    val kotlinVersion = extra["kotlin.version"] as String
    val gradleVersion = extra["gradle.version"] as String
    val composeVersion = extra["compose.version"] as String

    kotlin("jvm").version(kotlinVersion)
    kotlin("multiplatform").version(kotlinVersion)
    kotlin("plugin.serialization").version(kotlinVersion)
    kotlin("android").version(kotlinVersion)

    id("com.android.application").version(gradleVersion)
    id("com.android.library").version(gradleVersion)
    id("org.jetbrains.compose").version(composeVersion)
}

repositories {
    google()
    mavenCentral()
    maven("https://maven.pkg.jetbrains.space/public/p/compose/dev")
}</code></pre>
        </div>
        <p class="reveal-item">After setting up versions, we proceed to work on the platform-specific 'shared' module.</p>
        <div class="code-block-wrap reveal-item">
          <button type="button" class="code-copy" aria-label="Copy code">Copy</button>
          <pre><code class="language-kotlin">// build.gradle.kts
plugins {
    kotlin("multiplatform")
    id("com.android.library")
    id("org.jetbrains.compose")
    kotlin("plugin.serialization")
}

listOf(
    iosX64(),
    iosArm64(),
    iosSimulatorArm64()
).forEach {
    it.binaries.framework {
        baseName = "shared"
        // IMPORTANTE: Include a static library instead of a dynamic one into the framework.
        isStatic = true
    }
}

val commonMain by getting {
    dependencies {
        // Compose Multiplatform
        implementation(compose.runtime)
        implementation(compose.foundation)
        implementation(compose.material)
        @OptIn(org.jetbrains.compose.ExperimentalComposeLibrary::class)
        implementation(compose.components.resources)

        /.../
    }
}</code></pre>
        </div>
        <p class="reveal-item">And add dependencies for Android &amp; iOS http client specifics.</p>
        <div class="code-block-wrap reveal-item">
          <button type="button" class="code-copy" aria-label="Copy code">Copy</button>
          <pre><code class="language-kotlin">val androidMain by getting {
    dependencies {
        val ktorVersion = extra["ktor.version"] as String
        implementation("io.ktor:ktor-client-okhttp:$ktorVersion")
    }
}
val iosMain by getting {
    dependencies {
        val ktorVersion = extra["ktor.version"] as String
        implementation("io.ktor:ktor-client-darwin:$ktorVersion")
    }
}</code></pre>
        </div>
        <p class="reveal-item">Now, it's time to dive into the UI development. We'll focus on creating a simple UI featuring a button to generate random useless facts from a server.</p>
        <div class="code-block-wrap reveal-item">
          <button type="button" class="code-copy" aria-label="Copy code">Copy</button>
          <pre><code class="language-kotlin">// shared/../FactasticApp.kt
@Composable
fun FactasticApp(viewModel: AppViewModel, modifier: Modifier = Modifier) {
    FactasticTheme {
        Surface(
            modifier = modifier.fillMaxSize(),
            color = MaterialTheme.colors.background
        ) {
            val state = viewModel.stateFlow.collectAsState()
            LaunchedEffect(Unit) {
                viewModel.loadUselessFact()
            }
            MainScreen(state.value, viewModel::onClick)
        }
    }
}</code></pre>
        </div>
        <blockquote class="reveal-item">
          <p>Business logic inside <code>AppViewModel</code> is <a href="https://github.com/vladleesi/factastic/blob/master/shared/src/commonMain/kotlin/dev/vladleesi/factastic/presentation/AppViewModel.kt" target="_blank" rel="noopener noreferrer">here</a>. Configuration of Ktor client is <a href="https://github.com/vladleesi/factastic/blob/master/shared/src/commonMain/kotlin/dev/vladleesi/factastic/data/api/HttpClient.kt" target="_blank" rel="noopener noreferrer">here</a>.</p>
        </blockquote>
        <p class="reveal-item">Behold, the moment for the grand trick has arrived.</p>
        <h3 class="reveal-item">Android</h3>
        <div class="code-block-wrap reveal-item">
          <button type="button" class="code-copy" aria-label="Copy code">Copy</button>
          <pre><code class="language-kotlin">class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        val viewModel = AppViewModel()
        setContent {
            FactasticApp(viewModel)
        }
    }
}</code></pre>
        </div>
        <h3 class="reveal-item">iOS</h3>
        <p class="reveal-item">Let's adapt our Compose code for iOS.</p>
        <div class="code-block-wrap reveal-item">
          <button type="button" class="code-copy" aria-label="Copy code">Copy</button>
          <pre><code class="language-kotlin">// shared/iosMain/../FactasticApp.kt

fun MainViewController(): UIViewController {
    val viewModel = AppViewModel()
    return ComposeUIViewController {
        FactasticApp(viewModel)
    }
}</code></pre>
        </div>
        <p class="reveal-item">Next, we should open Xcode to work on the iOS part, as we need to perform some Swift-related tasks. Locate <code>iosApp/iosApp.xcodeproj</code>, right-click on it, and then choose "Open in" → "Xcode."</p>
        <p class="reveal-item">In Xcode, create a new Swift file named "ComposeView.swift" by clicking on "File" → "New" → "File..." → "Swift File" → "Next" → "ComposeView.swift" → "Create."</p>
        <blockquote class="reveal-item">
          <p>Oh my God, what is this? Is it Swift?</p>
        </blockquote>
        <div class="code-block-wrap reveal-item">
          <button type="button" class="code-copy" aria-label="Copy code">Copy</button>
          <pre><code class="language-swift">// ComposeView.swift

import Foundation
import SwiftUI
import shared

struct ComposeView: UIViewControllerRepresentable {
    func updateUIViewController(_ uiViewController: UIViewControllerType, context: Context) {
        // ignore
    }

    func makeUIViewController(context: Context) -> some UIViewController {
        FactasticAppKt.MainViewController()
    }
}</code></pre>
        </div>
        <p class="reveal-item">Make a minor update to the existing <code>ContentView.swift</code> file in Xcode.</p>
        <div class="code-block-wrap reveal-item">
          <button type="button" class="code-copy" aria-label="Copy code">Copy</button>
          <pre><code class="language-swift">import SwiftUI
import shared

struct ContentView: View {
   var body: some View {
      // This one
      ComposeView()
   }
}

struct ContentView_Previews: PreviewProvider {
	static var previews: some View {
		ContentView()
	}
}</code></pre>
        </div>
        <p class="reveal-item">That's all the Xcode part, you may forget about it (if you can) and return to Android Studio.</p>
        <p class="reveal-item">Before running the app, we must build the iOS module using the following command: <code>./gradlew :shared:compileKotlinIosArm64</code>.</p>
        <p class="reveal-item">In Android Studio, select the target platform, and then click on the "Run" button to launch the application on the chosen platform.</p>
        <figure class="reveal-item">
          <img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wy2c9iv7xbl1vms6qo3z.jpg" alt="Choosing target platform for launch" loading="lazy">
        </figure>
        <p class="reveal-item">Well done!</p>
        <div class="article-body-table reveal-item">
          <figure>
            <img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/tvgbm18ch9x2vmypi0z2.gif" alt="Android (Dark theme)" loading="lazy">
            <figcaption>Android (Dark theme)</figcaption>
          </figure>
          <figure>
            <img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/htgbvoh1d4402og8ims6.gif" alt="iOS (Light theme)" loading="lazy">
            <figcaption>iOS (Light theme)</figcaption>
          </figure>
        </div>
        <p class="reveal-item"><strong>Resources:</strong></p>
        <ul class="reveal-item">
          <li><a href="https://kotlinlang.org/docs/multiplatform-mobile-getting-started.html" target="_blank" rel="noopener noreferrer">Kotlin Multiplatform for mobile</a></li>
          <li><a href="https://www.jetbrains.com/lp/compose-multiplatform/" target="_blank" rel="noopener noreferrer">Compose Multiplatform</a></li>
          <li><a href="https://kotlinlang.org/docs/coroutines-overview.html" target="_blank" rel="noopener noreferrer">Kotlin Coroutines</a></li>
          <li><a href="https://kotlinlang.org/docs/serialization.html" target="_blank" rel="noopener noreferrer">Kotlin Serialization</a></li>
          <li><a href="https://ktor.io/docs/getting-started-ktor-client.html" target="_blank" rel="noopener noreferrer">Ktor</a></li>
          <li><a href="https://github.com/AAkira/Napier" target="_blank" rel="noopener noreferrer">Napier</a></li>
        </ul>
        <p class="reveal-item"><strong>Update as of 08/02/2023:</strong> Additionally, I have incorporated <a href="https://github.com/vladleesi/factastic/tree/master/desktop" target="_blank" rel="noopener noreferrer">the desktop module</a> into the project.</p>
        <p class="reveal-item"><strong>P.S.</strong> I'd greatly appreciate receiving feedback. If my examples happen to be useful to you, please, consider giving a star to the <a href="https://github.com/vladleesi/factastic" target="_blank" rel="noopener noreferrer">GitHub repository</a>. Thank you!</p>
      </div>
    </article>
  </main>
  <div id="site-footer"></div>
  <script src="../assets/js/site.config.js" defer></script>
  <script src="../assets/js/layout.js" defer></script>
  <script src="../assets/js/script.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-kotlin.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-groovy.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-swift.min.js" defer></script>
  <script src="../assets/js/article.js" defer></script>
</body>
</html>
